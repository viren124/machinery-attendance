<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Machinery Attendance ‚Äî Management Ready</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f7fb; --card:#ffffff; --accent:#0b84ff; --muted:#6b7280; --danger:#b71c1c;
  --c1:#e8f6ff; --c2:#fff6e8; --c3:#eefcf1; --c4:#f6eefc; --c5:#fff1f0;
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;color:#0b2b3b}
.topbar{background:linear-gradient(90deg,var(--accent),#0066cc);color:#fff;padding:12px 18px;display:flex;align-items:center;gap:16px;box-shadow:0 4px 20px rgba(11,60,120,0.12)}
.brand{font-weight:700;font-size:16px}
.tabs{display:flex;gap:8px}
.tab{background:rgba(255,255,255,0.08);padding:8px 12px;border-radius:8px;cursor:pointer;color:#eaf6ff;font-weight:600}
.tab.active{background:#fff;color:#0b4c9e;box-shadow:0 2px 6px rgba(11,60,120,0.06)}
.container{max-width:1200px;margin:18px auto;padding:18px}
.card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 30px rgba(12,30,60,0.06)}
.row{display:flex;gap:12px;align-items:center}
.col{flex:1}
label{font-size:13px;color:#213343;display:block;margin-bottom:6px}
input[type=text], input[type=date], select{width:100%;padding:9px;border:1px solid #e6eef7;border-radius:8px;font-size:14px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;align-items:center}
button{padding:8px 10px;border-radius:8px;border:1px solid #d7e3f0;background:#fff;cursor:pointer;font-weight:700}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.small{font-size:13px;color:var(--muted);margin-top:8px}
.table-wrap{overflow:auto;margin-top:12px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:9px;border:1px solid #eef4fb;text-align:left;vertical-align:middle}
th{background:#f3f9ff;color:#07385c;font-weight:700}
tbody tr:nth-child(even){background:#fbfeff}
.number-plate input{border:none;background:transparent;color:var(--danger);font-weight:700}
.right{margin-left:auto;display:flex;gap:8px;align-items:center}
.empty{color:#7b8b99;text-align:center;padding:14px}
/* Panels */
.side-panel{position:fixed;right:-460px;top:0;height:100%;width:420px;background:#fff;box-shadow:-10px 0 30px rgba(11,30,60,0.12);transition:right .28s;z-index:1400;padding:18px;overflow:auto}
.side-panel.open{right:0}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.18);z-index:1300;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.show{opacity:1;pointer-events:auto}
.supplier-row, .proj-row{display:flex;gap:8px;align-items:center;border-bottom:1px solid #f1f5f9;padding:10px 0}
.supplier-row .name, .proj-row .name{flex:1;font-weight:600;color:#0b3b63}
.proj-row .fields{display:flex;gap:8px;width:100%}
.proj-row input{padding:6px;border:1px solid #e6eef7;border-radius:6px}
.summary-table{overflow:auto;margin-top:12px}
.summary-table table th, .summary-table table td{white-space:nowrap}
.totals{background:#2e7d32;color:#fff;font-weight:800}
.color-c1{background:var(--c1)}
.color-c2{background:var(--c2)}
.color-c3{background:var(--c3)}
.color-c4{background:var(--c4)}
.color-c5{background:var(--c5)}
.filter-row{display:flex;gap:8px;align-items:center;margin-top:12px}
@media(max-width:920px){.row{flex-direction:column}.right{justify-content:flex-end} .side-panel{width:100%}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Machinery Attendance ‚Äî Management Ready</div>
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="attendance">üìã Attendance</div>
      <div class="tab" data-tab="summary">üìä Summary</div>
      <div class="tab" data-tab="full">üìÅ Full Attendance</div>
    </div>
    <div style="flex:1"></div>
    <div style="display:flex;gap:8px;">
      <button id="manageProjectsBtn">üèó Manage Projects</button>
      <button id="manageSuppliersBtn">‚öô Manage Suppliers</button>
    </div>
  </div>

  <div class="container">
    <!-- Attendance -->
    <div id="attendance" class="card" style="display:block">
      <div class="row">
        <div class="col">
          <label for="date">Date</label>
          <input type="date" id="date">
        </div>
        <div class="col">
          <label for="siteSelect">Project</label>
          <select id="siteSelect"></select>
        </div>
        <div class="col">
          <label for="engineer">Engineer</label>
          <input type="text" id="engineer" placeholder="Engineer name">
        </div>
        <div style="width:220px">
          <label for="projCode">Project Code</label>
          <input type="text" id="projCode" placeholder="PJxxxx" readonly>
        </div>
      </div>

      <div class="controls">
        <button class="primary" id="addBtn">+ Add Equipment</button>
        <button id="saveAttendanceBtn">üíæ Save Attendance</button>
        <button id="saveTemplateBtn">üíæ Save Template</button>
        <button id="exportAllBtn">üì• Export All Attendance</button>
        <div style="flex:1"></div>
        <div class="right">
          <button id="loadTemplateBtn">üìÇ Load Template</button>
          <button id="clearBtn">üóë Clear Table</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="attendanceTable">
          <thead>
            <tr><th style="width:36px">‚úì</th><th style="width:48px">Sr</th><th>Machine</th><th>Plate Number</th><th style="width:140px">Present/Absent</th><th>Supplier</th><th style="width:90px">Action</th></tr>
          </thead>
          <tbody id="tbody"><tr class="empty"><td colspan="7">Select a project to load its machinery list.</td></tr></tbody>
        </table>
      </div>
      <div class="small">Edit any row and click <strong>Save Template</strong> to persist changes for this project (saved locally).</div>
    </div>

    <!-- Summary -->
    <div id="summary" class="card" style="display:none; margin-top:18px">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="font-weight:700">Project Summary</div>
        <div class="small">Counts of Present machines by category for selected date</div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <label for="summaryDate">Date</label>
          <input type="date" id="summaryDate" />
          <button id="exportSummaryXLS">üì• Export Summary (.xls)</button>
        </div>
      </div>
      <div class="summary-table">
        <table id="summaryTable">
          <thead><tr id="summaryHeader"></tr></thead>
          <tbody id="summaryBody"></tbody>
          <tfoot id="summaryFoot"></tfoot>
        </table>
      </div>
    </div>

    <!-- Full Attendance -->
    <div id="full" class="card" style="display:none; margin-top:18px">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="font-weight:700">Full Attendance</div>
        <div class="small">All saved attendance records</div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px;align-items:center">
          <label>Filter</label>
          <select id="filterProject"><option value="">-- All projects --</option></select>
          <button id="exportFullXLS">üì• Export Full (.xls)</button>
        </div>
      </div>
      <div style="margin-top:12px" class="table-wrap">
        <table id="fullTable">
          <thead><tr><th>Date</th><th>Project</th><th>Project Code</th><th>Engineer</th><th>Machine</th><th>Plate</th><th>Supplier</th><th>Status</th></tr></thead>
          <tbody id="fullBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Panels -->
  <div class="overlay" id="overlay"></div>

  <aside class="side-panel" id="projPanel">
    <h3>Manage Projects</h3>
    <div class="muted">Update project codes and default engineer names (changes saved locally).</div>
    <div id="projList" style="margin-top:12px"></div>
    <div style="margin-top:12px"><button id="closeProj">Close</button></div>
  </aside>

  <aside class="side-panel" id="supPanel">
    <h3>Manage Suppliers</h3>
    <div class="muted">Add / rename / delete suppliers.</div>
    <div id="supList" style="margin-top:12px"></div>
    <div style="margin-top:12px;display:flex;gap:8px"><input id="newSupplierInput" placeholder="New supplier name" /><button id="addSupplierBtn">‚ûï Add</button></div>
    <div style="margin-top:12px"><button id="closeSup">Close</button></div>
  </aside>

<script>
// Storage keys
const SITE_KEY = 'mas_templates_v2';
const ATT_KEY = 'mas_attendance_v2';
const SUP_KEY = 'mas_suppliers_v2';
const PROJ_KEY = 'mas_projects_v2';

// Projects list (15 specified) with default codes & engineers
const PROJECTS_ORDER = [
  {name:"DAMAC LAGOONS SANTORINI", code:"PJ2309", engineer:"Shareef", color:"color-c1"},
  {name:"BACKBONE", code:"PJ2409", engineer:"Shareef", color:"color-c2"},
  {name:"STREETSCAPE - COSTABRAVA", code:"PJ2414", engineer:"Shareef", color:"color-c3"},
  {name:"DAMAC LAGOONS PORTOFINO", code:"PJ2406", engineer:"Hussain", color:"color-c4"},
  {name:"COSTA BRAVA", code:"PJ2410", engineer:"Mustafa", color:"color-c5"},
  {name:"NICE (OPEN SPACE)", code:"PJ2417", engineer:"Mustafa", color:"color-c1"},
  {name:"DAMAC LAGOONS CENTRAL HUB", code:"PJ2323", engineer:"Mohammed Hussein", color:"color-c2"},
  {name:"DH1 CAVALI 31 POOLS", code:"PJ2321", engineer:"DH1 & DH2 Projects", color:"color-c3"},
  {name:"20177 MURGHAM Rural Neighborhood Garden", code:"PJ2412", engineer:"Emad Shorkey", color:"color-c4"},
  {name:"20182 KHAWANEEJ Neighborhood Model Residential (Group G)", code:"PJ2416", engineer:"Emad Shorkey", color:"color-c5"},
  {name:"NEIGHBORHOOD MODEL RESIDENTIAL PARKS (GROUP A)", code:"PJ2421", engineer:"Sharaf", color:"color-c1"},
  {name:"DANAH BAY", code:"PJ2324", engineer:"", color:"color-c2"},
  {name:"Site Office", code:"", engineer:"Osama", color:"color-c3"},
  {name:"MEP", code:"", engineer:"ENGR. ANEESH", color:"color-c4"},
  {name:"IRRIGATION", code:"GENERAL", engineer:"ENGR. RAGAB", color:"color-c5"}
];

// Preloaded suppliers
const PRELOADED_SUPPLIERS = ["PHOENICIAN TECHNICAL SERVICES","Rashid Ali","Zaas Transport","Banaras Fazal Transport",
"CD Horizon","Khatt Transport","Farman Transport","German Gulf","Al Qadeer general transport","Sama Al Madina",
"City Star","Al Farhan Transport","Noor Al Afghan","New Kashmir star","Address Luxury Passenger Transport",
"Noor al ethihad","Four Star","Boom Crane","Al Onood","Road Worrior"];

// Preloaded machinery mapping for the 15 projects (trimmed from master list)
const PRELOADED_TEMPLATES = {
 "DAMAC LAGOONS SANTORINI":[
  {"name":"Bobcat","plate":"15846","supplier":"PHOENICIAN TECHNICAL SERVICES"},
  {"name":"Bobcat","plate":"97374","supplier":"Rashid Ali"},
  {"name":"Bobcat","plate":"62554","supplier":"Rashid Ali"},
  {"name":"BoomLoader","plate":"16963","supplier":"CD Horizon"},
  {"name":"BoomLoader","plate":"16971","supplier":"CD Horizon"},
  {"name":"Shovel (966)","plate":"53348","supplier":"Rashid Ali"},
  {"name":"JCB","plate":"25450","supplier":"Rashid Ali"},
  {"name":"JCB","plate":"59617","supplier":"Rashid Ali"},
  {"name":"Tipper Truck","plate":"21654","supplier":"Rashid Ali"},
  {"name":"6 wheels","plate":"73037","supplier":"Rashid Ali"},
  {"name":"6 wheels","plate":"30938","supplier":"Rashid Ali"},
  {"name":"Hiab Cran 10 Ton","plate":"80130","supplier":"Farman Transport"},
  {"name":"Tanker","plate":"95583","supplier":"Road Worrior"}
 ],
 "BACKBONE":[
  {"name":"Bobcat","plate":"16802","supplier":"PHOENICIAN TECHNICAL SERVICES"},
  {"name":"BoomLoader","plate":"82483","supplier":"CD Horizon"},
  {"name":"Tipper Truck","plate":"32594","supplier":"Rashid Ali"},
  {"name":"Mobile Crane","plate":"36431","supplier":"Boom Crane"},
  {"name":"1 Ton Pickup","plate":"43948","supplier":"Noor Al Afghan"}
 ],
 "STREETSCAPE - COSTABRAVA":[
  {"name":"Shovel 650","plate":"51571","supplier":"Rashid Ali"},
  {"name":"BoomLoader","plate":"16962","supplier":"CD Horizon"},
  {"name":"Tipper Truck","plate":"73453","supplier":"Rashid Ali"}
 ],
 "DAMAC LAGOONS PORTOFINO":[
  {"name":"Bobcat","plate":"16802","supplier":"PHOENICIAN TECHNICAL SERVICES"},
  {"name":"BoomLoader","plate":"82483","supplier":"CD Horizon"},
  {"name":"Tipper Truck","plate":"32594","supplier":"Rashid Ali"},
  {"name":"Mobile Crane","plate":"36431","supplier":"Boom Crane"}
 ],
 "COSTA BRAVA":[
  {"name":"Bobcat","plate":"26675","supplier":"Rashid Ali"},
  {"name":"JCB","plate":"84235","supplier":"Zaas Transport"},
  {"name":"Shovel 650","plate":"51571","supplier":"Rashid Ali"},
  {"name":"Tipper Truck","plate":"73453","supplier":"Rashid Ali"}
 ],
 "NICE (OPEN SPACE)":[
  {"name":"Bobcat","plate":"83619","supplier":"Zaas Transport"},
  {"name":"Shovel","plate":"53460","supplier":"Rashid Ali"},
  {"name":"Excavator","plate":"15644","supplier":"Al Qadeer general transport"},
  {"name":"Tipper Truck","plate":"51976","supplier":"Rashid Ali"}
 ],
 "DAMAC LAGOONS CENTRAL HUB":[
  {"name":"Bobcat","plate":"16972","supplier":"CD Horizon"},
  {"name":"Tipper Truck","plate":"63904","supplier":"Rashid Ali"}
 ],
 "DH1 CAVALI 31 POOLS":[
  {"name":"Tipper Truck","plate":"56196","supplier":"PHOENICIAN TECHNICAL SERVICES"},
  {"name":"1 Ton Pickup","plate":"20699","supplier":"PHOENICIAN TECHNICAL SERVICES"}
 ],
 "20177 MURGHAM Rural Neighborhood Garden":[
  {"name":"BoomLoader","plate":"43075","supplier":"Rashid Ali"},
  {"name":"1 Ton Pickup","plate":"84506","supplier":"Al Farhan Transport"}
 ],
 "20182 KHAWANEEJ Neighborhood Model Residential (Group G)":[
  {"name":"BoomLoader","plate":"16965","supplier":"CD Horizon"},
  {"name":"1 Ton Pickup","plate":"18945","supplier":"City Star"},
  {"name":"Tipper Truck","plate":"27614","supplier":"Rashid Ali"}
 ],
 "NEIGHBORHOOD MODEL RESIDENTIAL PARKS (GROUP A)":[
  {"name":"JCB","plate":"35931","supplier":"Rashid Ali"},
  {"name":"14 Seater Hi-Ace","plate":"32844","supplier":"City star"}
 ],
 "DANAH BAY":[
  {"name":"BoomLoader","plate":"30822","supplier":"Khatt Transport"},
  {"name":"Bus","plate":"35106","supplier":"City Star"}
 ],
 "Site Office":[
  {"name":"14 Seater Hi-Ace","plate":"64886","supplier":"New Kashmir star"},
  {"name":"Coster 30 Seater","plate":"52443","supplier":"Noor al ethihad"}
 ],
 "MEP":[
  {"name":"1 Ton Pickup","plate":"58195","supplier":"City star"},
  {"name":"Tipper Truck","plate":"74736","supplier":"Rashid Ali"}
 ],
 "IRRIGATION":[
  {"name":"BoomLoader","plate":"25532","supplier":"CD Horizon"},
  {"name":"JCB","plate":"59617","supplier":"Rashid Ali"},
  {"name":"1 Ton Pickup","plate":"14542","supplier":"Noor Al Afghan"},
  {"name":"Tipper Truck","plate":"46039","supplier":"Rashid Ali"}
 ]
};

// Initialize storage if missing
function initStorage(){
  if(!localStorage.getItem(SITE_KEY)) localStorage.setItem(SITE_KEY, JSON.stringify(PRELOADED_TEMPLATES));
  if(!localStorage.getItem(SUP_KEY)) localStorage.setItem(SUP_KEY, JSON.stringify(PRELOADED_SUPPLIERS));
  if(!localStorage.getItem(PROJ_KEY)) localStorage.setItem(PROJ_KEY, JSON.stringify(PROJECTS_ORDER.reduce((o,p)=>{ o[p.name]={code:p.code,engineer:p.engineer,color:p.color}; return o; }, {})));
  if(!localStorage.getItem(ATT_KEY)) localStorage.setItem(ATT_KEY, JSON.stringify([]));
}

function $(id){ return document.getElementById(id); }

document.addEventListener('DOMContentLoaded', ()=>{
  initStorage();
  populateProjectSelect();
  populateFilterProject();
  populateSuppliersPanel();
  populateProjectsPanel();
  bindEvents();
  $('date').value = new Date().toISOString().slice(0,10);
  $('summaryDate').value = $('date').value;
  renderSummary();
  renderFullTable();
});

function bindEvents(){
  document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    $('attendance').style.display = tab==='attendance' ? 'block':'none';
    $('summary').style.display = tab==='summary' ? 'block':'none';
    $('full').style.display = tab==='full' ? 'block':'none';
    if(tab==='summary'){ renderSummary(); }
    if(tab==='full'){ renderFullTable(); }
  }));
  $('manageSuppliersBtn').addEventListener('click', openSupPanel);
  $('closeSup').addEventListener('click', closeSupPanel);
  $('manageProjectsBtn').addEventListener('click', openProjPanel);
  $('closeProj').addEventListener('click', closeProjPanel);
  $('addSupplierBtn').addEventListener('click', addSupplierFromInput);
  $('siteSelect').addEventListener('change', onProjectChange);
  $('addBtn').addEventListener('click', ()=> addRow());
  $('saveAttendanceBtn').addEventListener('click', saveAttendance);
  $('saveTemplateBtn').addEventListener('click', saveTemplateForProject);
  $('loadTemplateBtn').addEventListener('click', ()=> loadTemplate($('siteSelect').value));
  $('clearBtn').addEventListener('click', clearTable);
  $('exportAllBtn').addEventListener('click', exportAllAttendance);
  $('exportSummaryXLS').addEventListener('click', ()=> exportSummary('xls'));
  $('summaryDate').addEventListener('change', renderSummary);
  $('filterProject').addEventListener('change', renderFullTable);
  $('exportFullXLS').addEventListener('click', exportFullAttendance);
  $('overlay').addEventListener('click', ()=>{ closeProjPanel(); closeSupPanel(); });
}

// Populate project dropdown (only 15 projects)
function populateProjectSelect(){
  const templates = JSON.parse(localStorage.getItem(PROJ_KEY));
  const sel = $('siteSelect'); sel.innerHTML = '<option value="">‚Äî Select project ‚Äî</option>';
  Object.keys(templates).forEach(name=>{
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name + (templates[name].code ? ' ('+templates[name].code+')' : '');
    sel.appendChild(opt);
  });
}

// Populate filter dropdown for full table
function populateFilterProject(){
  const sel = $('filterProject'); sel.innerHTML = '<option value="">-- All projects --</option>';
  const templates = JSON.parse(localStorage.getItem(PROJ_KEY));
  Object.keys(templates).forEach(name=>{
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
    sel.appendChild(opt);
  });
}

// on project change: autofill engineer & project code, and load template
function onProjectChange(){
  const name = $('siteSelect').value;
  const projects = JSON.parse(localStorage.getItem(PROJ_KEY));
  if(name && projects[name]){
    $('engineer').value = projects[name].engineer || '';
    $('projCode').value = projects[name].code || '';
  } else { $('engineer').value=''; $('projCode').value=''; }
  // load template automatically if exists
  loadTemplate(name);
}

// load template (from SITE_KEY storage)
function loadTemplate(name){
  if(!name) return;
  const templates = JSON.parse(localStorage.getItem(SITE_KEY) || '{}');
  const list = templates[name] || [];
  $('tbody').innerHTML = '';
  if(!list.length){ $('tbody').innerHTML = '<tr class="empty"><td colspan="7">No machines preloaded for this project.</td></tr>'; return; }
  list.forEach(item=> addRow(item));
  renumber();
}

// add a row to table; item optional {name, plate, supplier, status}
function addRow(item){
  const tbody = $('tbody');
  const empty = tbody.querySelector('.empty');
  if(empty) empty.remove();
  const tr = document.createElement('tr');
  const idx = tbody.querySelectorAll('tr').length + 1;
  tr.innerHTML = `
    <td style="text-align:center"><input type="checkbox" class="sel" /></td>
    <td style="text-align:center" class="sr">${idx}</td>
    <td><input class="name" value="${item && item.name ? escapeHtml(item.name): ''}" /></td>
    <td class="number-plate"><input class="plate" value="${item && item.plate ? escapeHtml(item.plate): ''}" /></td>
    <td>
      <select class="status"><option>Present</option><option>Absent</option></select>
    </td>
    <td><select class="supplier"></select></td>
    <td style="text-align:center"><button class="del">Remove</button></td>
  `;
  tbody.appendChild(tr);
  populateSupplierSelect(tr.querySelector('.supplier'));
  if(item && item.supplier){ const sList = getSuppliers(); if(!sList.includes(item.supplier)){ sList.push(item.supplier); setSuppliers(sList); populateSuppliersPanel(); populateSupplierSelectAll(); } tr.querySelector('.supplier').value = item.supplier; }
  if(item && item.status) tr.querySelector('.status').value = item.status;
  tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); renumber(); ensureEmpty(); });
  tr.querySelector('.supplier').addEventListener('change', ()=>{ if(tr.querySelector('.supplier').value==='__other__'){ const nv = prompt('New supplier name:',''); if(nv && nv.trim()){ const list=getSuppliers(); list.push(nv.trim()); setSuppliers(list); populateSuppliersPanel(); populateSupplierSelectAll(); tr.querySelector('.supplier').value = nv.trim(); } else tr.querySelector('.supplier').value=''; } });
  renumber();
}

function renumber(){ const rows = $('tbody').querySelectorAll('tr'); let n=0; rows.forEach(r=>{ if(r.classList.contains('empty')) return; n++; const el=r.querySelector('.sr'); if(el) el.textContent=n; }); }
function ensureEmpty(){ if(!$('tbody').querySelector('tr')) $('tbody').innerHTML = '<tr class="empty"><td colspan="7">No machines ‚Äî add or load template.</td></tr>'; }

// Suppliers
function getSuppliers(){ try{return JSON.parse(localStorage.getItem(SUP_KEY) || '[]'); }catch(e){ return []; } }
function setSuppliers(arr){ localStorage.setItem(SUP_KEY, JSON.stringify(arr)); }
function populateSupplierSelect(sel){ sel.innerHTML='<option value="">‚Äî choose supplier ‚Äî</option>'; getSuppliers().forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); const other=document.createElement('option'); other.value='__other__'; other.textContent='Other...'; sel.appendChild(other); }
function populateSupplierSelectAll(){ document.querySelectorAll('.supplier').forEach(s=> populateSupplierSelect(s)); }
function populateSuppliersPanel(){ const list=getSuppliers(); const container=$('supList'); container.innerHTML=''; list.forEach((s,idx)=>{ const div=document.createElement('div'); div.className='supplier-row'; div.innerHTML=`<div class="name">${escapeHtml(s)}</div><div style="display:flex;gap:6px"><button class="edit" data-idx="${idx}">‚úèÔ∏è</button><button class="del" data-idx="${idx}">üóëÔ∏è</button></div>`; container.appendChild(div); }); container.querySelectorAll('button.edit').forEach(b=> b.addEventListener('click', ()=>{ const i=parseInt(b.dataset.idx); const list=getSuppliers(); const old=list[i]; const nv=prompt('Edit supplier:', old); if(!nv) return; list[i]=nv.trim(); setSuppliers(list); populateSuppliersPanel(); populateSupplierSelectAll(); })); container.querySelectorAll('button.del').forEach(b=> b.addEventListener('click', ()=>{ const i=parseInt(b.dataset.idx); const list=getSuppliers(); const name=list[i]; if(!confirm('Delete '+name+'? Existing templates keep the string.')) return; list.splice(i,1); setSuppliers(list); populateSuppliersPanel(); populateSupplierSelectAll(); })); }

function addSupplierFromInput(){ const v=$('newSupplierInput').value.trim(); if(!v) return alert('Enter supplier name'); const list=getSuppliers(); if(!list.includes(v)){ list.push(v); setSuppliers(list); $('newSupplierInput').value=''; populateSuppliersPanel(); populateSupplierSelectAll(); alert('Added'); } else alert('Already exists'); }

// Projects manager
function getProjects(){ try{return JSON.parse(localStorage.getItem(PROJ_KEY) || '{}'); }catch(e){ return {}; } }
function setProjects(obj){ localStorage.setItem(PROJ_KEY, JSON.stringify(obj)); }
function populateProjectsPanel(){ const list=getProjects(); const container=$('projList'); container.innerHTML=''; Object.keys(list).forEach(name=>{ const row=document.createElement('div'); row.className='proj-row'; row.innerHTML=`<div class="name">${escapeHtml(name)}</div><div class="fields"><input value="${escapeHtml(list[name].code||'')}" data-name="${escapeHtml(name)}" data-field="code" placeholder="Project Code" /><input value="${escapeHtml(list[name].engineer||'')}" data-name="${escapeHtml(name)}" data-field="engineer" placeholder="Default Engineer" /></div>`; container.appendChild(row); }); container.querySelectorAll('.proj-row input').forEach(inp=> inp.addEventListener('change', ()=>{ const name=inp.dataset.name; const field=inp.dataset.field; const val=inp.value; const list=getProjects(); if(!list[name]) list[name]={}; list[name][field]=val; setProjects(list); populateProjectSelect(); populateFilterProject(); })); }

// Save template for current project (overwrite)
function saveTemplateForProject(){ const site=$('siteSelect').value; if(!site) return alert('Select project'); const rows=Array.from($('tbody').querySelectorAll('tr')).filter(r=>!r.classList.contains('empty')); const list=rows.map(r=>({ name:r.querySelector('.name').value.trim(), plate:r.querySelector('.plate').value.trim(), supplier:r.querySelector('.supplier').value||'' })).filter(x=>x.name||x.plate); const templates=JSON.parse(localStorage.getItem(SITE_KEY)||'{}'); templates[site]=list; localStorage.setItem(SITE_KEY, JSON.stringify(templates)); alert('Template saved for '+site); }

// Save attendance record
function saveAttendance(){ const date=$('date').value; if(!date) return alert('Select date'); const site=$('siteSelect').value; if(!site) return alert('Select project'); const projData=getProjects()[site]||{}; const projectCode=projData.code||$('projCode').value||''; const engineer=$('engineer').value.trim(); const rows=Array.from($('tbody').querySelectorAll('tr')).filter(r=>!r.classList.contains('empty')); if(!rows.length) return alert('No machines to save'); const equipment=rows.map(r=>({ machine:r.querySelector('.name').value.trim(), plate:r.querySelector('.plate').value.trim(), supplier:r.querySelector('.supplier').value||'', status:r.querySelector('.status').value })).filter(x=>x.machine||x.plate); const rec={ id: Date.now(), date, site, projectCode, engineer, equipment, savedAt: new Date().toISOString() }; const att=getAttendances(); att.push(rec); setAttendances(att); alert('Attendance saved for '+site); renderSummary(); renderFullTable(); }

function getAttendances(){ try{return JSON.parse(localStorage.getItem(ATT_KEY)||'[]'); }catch(e){ return []; } }
function setAttendances(arr){ localStorage.setItem(ATT_KEY, JSON.stringify(arr)); }

// Export all attendance (xls)
function exportAllAttendance(){ const data=getAttendances(); if(!data.length) return alert('No attendance saved'); let rows=[]; data.forEach(rec=> rec.equipment.forEach(eq=> rows.push([rec.date, rec.site, rec.projectCode, rec.engineer, eq.machine, eq.plate, eq.supplier, eq.status]))); const header=['Date','Project','Project Code','Engineer','Machine','Plate','Supplier','Status']; downloadTableAsExcel(header, rows, 'all_attendance'); }

// Render summary (counts of Present by category)
function renderSummary(){ const date = $('summaryDate').value || $('date').value; const att = getAttendances(); // count present per project by category keywords
 const headerRow = ['Project','Bobcat','BoomLoader','Shovel','JCB','Excavator','Pickups','Tipper Truck','Buses','Cranes','Tanker','Total']; const headerEl = $('summaryHeader'); headerEl.innerHTML=''; headerRow.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; headerEl.appendChild(th); });
 const body = $('summaryBody'); body.innerHTML=''; let totals = Array(headerRow.length-2).fill(0); // exclude Project and Total at end
 const projects = getProjects();
 Object.keys(projects).forEach((projName)=>{ const tr=document.createElement('tr'); const projInfo = projects[projName]; const colorClass = projInfo.color || ''; if(colorClass) tr.classList.add(colorClass); const tdName = document.createElement('td'); tdName.textContent = projName; tr.appendChild(tdName); // init counts
 const counts = {Bobcat:0,BoomLoader:0,Shovel:0,JCB:0,Excavator:0,Pickups:0,"Tipper Truck":0,Buses:0,Cranes:0,Tanker:0}; // find matching attendance records for projName on date (if date empty use latest)
 let records = att.filter(a=>a.site===projName && a.date===date);
 if(!records.length && !date){ const p = att.filter(a=>a.site===projName); if(p.length) records=[p[p.length-1]]; }
 records.forEach(rec=> rec.equipment.forEach(eq=>{ if(eq.status!=='Present') return; const name=(eq.machine||'').toLowerCase(); if(name.includes('bobcat')) counts.Bobcat++; if(name.includes('boomloader')||name.includes('boom')) counts.BoomLoader++; if(name.includes('shovel')||name.includes('excavator')) counts.Shovel++; if(name.includes('jcb')) counts.JCB++; if(name.includes('excavator')) counts.Excavator++; if(name.includes('pickup')||name.includes('1 ton')) counts.Pickups++; if(name.includes('tipper')||name.includes('truck')||name.includes('6 wheels')) counts['Tipper Truck']++; if(name.includes('bus')||name.includes('seater')) counts.Buses++; if(name.includes('crane')||name.includes('hiab')) counts.Cranes++; if(name.includes('tanker')) counts.Tanker++; }));
 let rowTotal=0; Object.keys(counts).forEach((k,idx)=>{ const td=document.createElement('td'); td.textContent = counts[k]||0; tr.appendChild(td); totals[idx]+=counts[k]; rowTotal+=counts[k]; }); const tdTot=document.createElement('td'); tdTot.textContent=rowTotal; tr.appendChild(tdTot); body.appendChild(tr); });
 // footer totals
 const foot = $('summaryFoot'); foot.innerHTML=''; const trf=document.createElement('tr'); trf.className='totals'; const tdLabel=document.createElement('td'); tdLabel.textContent='Totals'; trf.appendChild(tdLabel); let grand=0; totals.forEach(v=>{ const td=document.createElement('td'); td.textContent=v; trf.appendChild(td); grand+=v; }); const tdG=document.createElement('td'); tdG.textContent=grand; trf.appendChild(tdG); foot.appendChild(trf); }

// Full attendance render
function renderFullTable(){ const tbody=$('fullBody'); tbody.innerHTML=''; const att=getAttendances(); const filter=$('filterProject').value; const list = filter? att.filter(a=>a.site===filter) : att; list.forEach(rec=> rec.equipment.forEach(eq=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${rec.date}</td><td>${escapeHtml(rec.site)}</td><td>${escapeHtml(rec.projectCode||'')}</td><td>${escapeHtml(rec.engineer||'')}</td><td>${escapeHtml(eq.machine||'')}</td><td>${escapeHtml(eq.plate||'')}</td><td>${escapeHtml(eq.supplier||'')}</td><td>${escapeHtml(eq.status||'')}</td>`; tbody.appendChild(tr); })); if(!tbody.querySelector('tr')) tbody.innerHTML='<tr><td colspan="8" class="empty">No attendance saved yet.</td></tr>'; }

// Export helpers
function downloadTableAsExcel(header, rows, filename){ let html = '<table border="1"><tr>' + header.map(h=>`<th>${h}</th>`).join('') + '</tr>'; rows.forEach(r=> html += '<tr>' + r.map(c=>`<td>${escapeHtml(c||'')}</td>`).join('') + '</tr>'); html += '</table>'; const blob = new Blob(['<html><meta charset="utf-8" /><body>' + html + '</body></html>'], {type: 'application/vnd.ms-excel'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename + '.xls'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

function exportSummary(type){ const rows=[]; document.querySelectorAll('#summaryBody tr').forEach(tr=>{ const cols=Array.from(tr.children).map(td=>td.textContent); rows.push(cols); }); const header = ['Project'].concat(['Bobcat','BoomLoader','Shovel','JCB','Excavator','Pickups','Tipper Truck','Buses','Cranes','Tanker']).concat(['Total']); downloadTableAsExcel(header, rows, 'summary_'+($('summaryDate').value||todayISO())); }

function exportFullAttendance(){ const att=getAttendances(); let rows=[]; att.forEach(rec=> rec.equipment.forEach(eq=> rows.push([rec.date, rec.site, rec.projectCode, rec.engineer, eq.machine, eq.plate, eq.supplier, eq.status]))); const header = ['Date','Project','Project Code','Engineer','Machine','Plate','Supplier','Status']; if(!rows.length) return alert('No attendance saved'); downloadTableAsExcel(header, rows, 'full_attendance'); }

// Utility functions
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function clearTable(){ if(!confirm('Clear current table?')) return; $('tbody').innerHTML=''; ensureEmpty(); }
function ensureEmpty(){ if(!$('tbody').querySelector('tr')) $('tbody').innerHTML = '<tr class="empty"><td colspan="7">No machines ‚Äî add or load template.</td></tr>'; }

// Project panel controls
function openProjPanel(){ document.getElementById('overlay').classList.add('show'); document.getElementById('projPanel').classList.add('open'); populateProjectsPanel(); }
function closeProjPanel(){ document.getElementById('overlay').classList.remove('show'); document.getElementById('projPanel').classList.remove('open'); }

// Suppliers panel
function openSupPanel(){ document.getElementById('overlay').classList.add('show'); document.getElementById('supPanel').classList.add('open'); populateSuppliersPanel(); }
function closeSupPanel(){ document.getElementById('overlay').classList.remove('show'); document.getElementById('supPanel').classList.remove('open'); }

// Projects data helpers (initial load)
function getProjects(){ try{return JSON.parse(localStorage.getItem(PROJ_KEY)||'{}'); }catch(e){ return {}; } }
function setProjects(obj){ localStorage.setItem(PROJ_KEY, JSON.stringify(obj)); }

// set suppliers if not present
function setSupDefaults(){ if(!localStorage.getItem(SUP_KEY)) localStorage.setItem(SUP_KEY, JSON.stringify(PRELOADED_SUPPLIERS)); }
function getSuppliers(){ try{return JSON.parse(localStorage.getItem(SUP_KEY)||'[]'); }catch(e){ return []; } }

// initialize some defaults then populate
(function initDefaults(){ initStorage(); setSupDefaults(); // ensure projects storage created
  const projStored = getProjects(); if(Object.keys(projStored).length===0){ const p = {}; PROJECTS_ORDER.forEach(x=> p[x.name] = {code:x.code, engineer:x.engineer, color:x.color}); setProjects(p); }
  populateSupplierSelectAll();
})();

</script>
</body>
</html>
